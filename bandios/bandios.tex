\documentclass[11pt,a4paper]{article}
\usepackage[T1]{fontenc}
\begin{document}
\title{Bandios}
\author{Alföldi Mátyás}
\maketitle
\tableofcontents
\pagebreak
\section*{Introduction}
\markright{}
\addcontentsline{toc}{section}{Introduction}
File: Onlineinstaller.bin\newline
VT: https://www.virustotal.com/gui/file/59c662a5207c6806046205348b22\newline
ee45da3f685fe022556716dbbd6643e61834
\newpage
\section*{VT report}
\markright{}
\addcontentsline{toc}{section}{VT report}
All the sections have an entropy of 6+, and the .rsrc section is close to 8, so there will definitely be some unpacking.\newline
There is also a zip file, which is related to plenty of malware, but isn't detected, I would say that it is most likely password protected,
like in the case of WannaCry.\newline
It also has quite a few exports, which is rather strange for an exe.\newline
Interesting Imports:
\begin{itemize}
\item GetAdaptersInfo
\item Http* functions
\item Internet* functions
\item \_TrackMouseEvent (Anti automatic sandbox analysis?)
\item CreateEvent,CreateThread,CreateProcess,WaitForSingleObject combo
\item Sleep (Anti vm?)
\item SetUnhandledExceptionFilter+UnhandledExceptionFilter combo
\item LoadLibrary* functions + GetProcAddress
\item Various file operations Copy/Move/Read/Write
\item Heap related functions
\item Tls functions
\item System information gathering
\item Resource handling functions
\item GetCurrentDirectory/TempPath + SetCurrentDirectory
\item DuplicateHandle (possibly used as a defense mechanism)
\item QueryPerformanceCounter
\item IsProcessorFeaturePresent
\item GetTickCount
\item Service related functions
\item Registry related functions
\item CreateStreamOnHGlobal
\item Com related functions + Variant
\item File time gathering/modification
\end{itemize}
Network related:
\begin{itemize}
\item DNS resolution for iostream.system.band
\item HTTP request to iostream.system.band/dump/io/time.php
\end{itemize}
File readings:
\begin{itemize}
\item Internet cache/history/cookies
\item autoexec.bat
\item On some systems it opens \textbackslash \textbackslash.\textbackslash PIPE\textbackslash lsarpc and \textbackslash\textbackslash.\textbackslash PIPE\textbackslash ROUTER
\end{itemize}
File modifications:
\begin{itemize}
\item <sys32>\textbackslash spoolsr.exe
\item <sys32>\textbackslash MS.dat
\item <sys32>\textbackslash KeyHook32.dll
\item <sys32>\textbackslash KH.dat
\item <sys32>\textbackslash usp20.dll
\item <sys32>\textbackslash UP.dat
\item <sys32>\textbackslash drivers\textbackslash iaStorE.sys
\item <tmp>\textbackslash 996E.tmp
\end{itemize}
Based on the above spoolsr.exe-MS.dat KeyHook32.dll-KH.dat usp20.dll-UP.dat belong together.\newline
The first is related to printers, and possibly data sent out for printing will be stored in MS.dat.\newline
The second is related to keylogging.\newline
And the driver is a defense mechanism.\newline
Registry modifications:
\begin{itemize}
\item Deletes proxy related keys.
\item Sets the SavedLegacySettings key
\end{itemize}
Services related:
\begin{itemize}
\item Creates the iaStorE service (the above mentioned driver) and also opens RASMAN
\end{itemize}
Mutexes:
\begin{itemize}
\item RasPbFile
\item ZonesCounterMutex
\item ZonesCacheCounterMutex
\item ZonesLockedCacheCounterMutex
\end{itemize}
\newpage
\section*{Static Analysis}
\markright{}
\addcontentsline{toc}{section}{Static Analysis}
One has to start here from the entry point, since it looks similar to a normal msvc built app, but there are some differences.\newline
Also CRC32,zinflate possibly for the zip file in the .rsrc, and rijndael\_td and \_te constants can be found, the later signaling that a rijndael implementation is built into this malware.\newline
Note: Functions/Variables named by me, will be in italic.
\subsection{entry}
\begin{itemize}
\item It starts with the usual \_\_\_security\_init\_cookie()
\item \textit{GetShowWindow} call, which is sort of junk code, since the return value isn't used anywhere.
\item In the next function call a global variable is set to 2
\item \textit{TryGetProcessHeap} is called and if it fails we call \_fast\_error\_exit with 0x1c
\item Next comes \textit{Init} which initializes proc addresses, fls, and tls
\end{itemize}
\subsection{GetShowWindow}
GetStartupInfoW is called and based on if dwFlags contains STARTF\_USESSHOWWINDOW it either returns wShowWindow or 10 for SW\_SHOWDEFAULT.
\subsection{TryGetProcessHeap}
Stores in a global variable (\textit{hProcessHeap}) the return value of GetProcessHeap, and returns \textit{hProcessHeap} != 0
\subsection{Init}
\begin{itemize}
\item First subcall is \textit{InitProcAddresses}
    \begin{itemize}
    \item First it calls EncodePointer with 0 and calls some setter functions for some pointers
    \item In between these setter calls, the address of the terminate function gets stored too in a global variable after run through EncodePointer
    \item Next we call GetModuleHandleW on kernel32.dll
    \item Finally we use GetProcAddress and store the returned value xor BB40E64E in global variables
    \end{itemize}
\item Next is \textit{InitCritSections} where we iterate over what seems like an array of LPCRITICAL\_SECTIONS and we call either InitializeCriticalSectionEx (if \textit{InitProcAddresses} managed to find it), or InitializeCriticalSectionAndSpinCount on it.
\item Next a function pointer is called, and some further initialization occurs
\item Finally we call main
\end{itemize}
\subsection{main}
\begin{itemize}
\item It gets a handle to the current process, opens its token, and tries to give it SeDebugPrivilege, and SeLoadDriverPrivilege.
\item Afterwards it checks with the help of GetModuleFileNameW and a self written/statically linked sprintf variation and an overly complicated compare if the -install flag was given. Lets see first where we go if the install flag isn't given. (First start)
  \begin{itemize}
  \item A Copy happens to the Tmp dir and a new process gets created most likely with the -install flag
  \item Next an unnamed event is created with bManualReset set to TRUE, and starts a Thread at 4079c0 (passed the event handle), and waits for its completion.
  \item In the started thread it seems like information is first gathered and afterwards it connects to iostream.system.band.
  \item It does some other stuff, which I'll have to look into more, but in the end it calls SetEvent on the eventHandle, which was passed during thread creation.
  \end{itemize}
  \begin{itemize}
  \item based on if it is (x86 or Intel Itanium based processor) or something else it will do one of the following:
    \begin{itemize}
    \item Disable Wow64FsRedirection
    \item Files get created in the SystemDirectory (In memory Xor-ing with 0xdd reveals the files.)
    \item Resources get loaded and a new file is created, based on it. (The files are zlib compressed)
    \item Revers Wow64FsRedirection
    \end{itemize}
    \begin{itemize}
    \item Do the same as above without Wow64FsRedirection
    \item Create and start a service
    \end{itemize}
  \item In the end it installs a Crash Dump Filter driver through registry modifications.
  \end{itemize}
\end{itemize}
\subsection{PE files hidden in the .rsrc}
\subsubsection{104:PE32+,DLL}
Seems relatively short, in the first function(InitVars) it sets to variables, one to the value 2b992ddfa232 and the negated value into another.
If the first parameter to the entry is 0 it calls a function(FUNCTION2) and sets the return value to 0xc0000009a (Insufficient system resources?)
FUNCTION2:
Inside the function some xor-ing happens in the .data section first, which based on the following RtlInitUnicodeString are strings. These are then passed further down to a function(FUNCTION3) in pairs.
Next 2 function calls happen to FUNCTION4, with the first value being an address to a variable, the second a 0, and the third what seems like a size value
FUNCTION3:

\subsubsection{106:PE32,DLL}
\subsubsection{108:PE32}
iaStorE.sys (compared hash to the dropped file in an any.run analysis)
\subsubsection{110:PE32+}
\subsubsection{111:PE32}
Todo: look into the In memory Xored + zlib compressed PE files.
\end{document}